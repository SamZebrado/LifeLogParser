<!--
SPDX-License-Identifier: MIT
Copyright (c) 2025 Sam Zebrado
-->

<!doctype html><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å¼¹å¹•æ—¥å¿—ï¼šæ‰“æ ‡ç­¾ + æ±‡æ€»æŸ¥çœ‹ï¼ˆæœ¬åœ°ç‰ˆï½œæŒ‰æ—¥æœŸï½œå¤šè¯­è¨€ï½œå«æ˜ŸæœŸï½œç‰ˆæœ¬ + åˆ é™¤æœ«è¡Œ + æ’å…¥ç²˜è´´ + å¯¼å…¥JSON + ä¿®æ”¹æŒ‡å®šè¡Œï¼‰</title>
<style>
html,body{height:100%;margin:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,'PingFang SC','Hiragino Sans GB','Microsoft YaHei',sans-serif;background:#fff}
.wrap{display:grid;grid-template-columns:1.4fr 1fr;gap:16px;height:100vh;padding:16px;box-sizing:border-box}
.panel{border:1px solid #e6e6e6;border-radius:10px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 1px 3px rgba(0,0,0,.03)}
.head{padding:10px 14px;border-bottom:1px solid #eee;background:#fafafa;font-weight:600;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.body{padding:12px 14px;overflow:auto}
.legend{margin:8px 0 12px;font-size:13px;color:#555}
.blue{background:#cfe8ff;border-radius:3px;padding:0 2px}
.green{background:#d8f5d0;border-radius:3px;padding:0 2px}
.cyan{background:#d5f8d0;border-radius:3px;padding:0 2px}
.content{white-space:pre-wrap;word-break:break-word;font-size:15px;line-height:1.65}
.entry{display:block;margin:8px 0;padding:2px 4px;border-left:4px solid transparent;cursor:pointer}
.entry.blue{border-left-color:#5aa0ff;background:#f1f7ff}
.entry.suspect{border-left-color:#6bd4f7;background:#f4fcff}
.entry.selected{outline:2px solid #5aa0ff}
.line{margin:2px 0}
.tools{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
input[type=text],input[type=number]{padding:6px 8px;border:1px solid #ddd;border-radius:8px;outline:none;min-width:120px}
input[type=text]:focus{border-color:#5aa0ff;box-shadow:0 0 0 3px rgba(90,160,255,.15)}
select{padding:6px 8px;border:1px solid #ddd;border-radius:8px;background:#fff}
button{padding:8px 12px;border:1px solid #333;border-radius:10px;background:#111;color:#fff;cursor:pointer}
button.secondary{background:#f6f7f8;color:#111;border-color:#ddd}
button:disabled{opacity:.5;cursor:not-allowed}
label.cb{display:inline-flex;align-items:center;gap:6px;font-size:13px;color:#333;padding:6px 8px;border:1px solid #ddd;border-radius:8px;background:#fff}
.muted{color:#666;font-size:12px}
.badge{display:inline-block;padding:2px 6px;border-radius:999px;background:#eef;border:1px solid #ccd;color:#335;font-size:12px;margin-left:6px}
.list{font-size:14px;line-height:1.6}
.sum{background:#fbfbfb;border:1px dashed #ddd;padding:10px;border-radius:8px;margin-top:8px}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;background:#f2f2f2;border:1px solid #e5e5e5;padding:1px 6px;border-radius:6px}
.dateSec{margin:12px 0 14px}
.dateHead{font-weight:700;margin:6px 0 4px}
.dateHead .mini{font-weight:400;color:#666;margin-left:6px}
.dateTotal{margin:6px 0 0}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:50}
.hidden{display:none}
.dialog{width:min(960px,94vw);max-height:84vh;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);display:flex;flex-direction:column}
.dialog .title{padding:12px 16px;border-bottom:1px solid #eee;font-weight:600}
.dialog .cont{padding:12px 16px;overflow:auto}
.dialog .actions{padding:12px 16px;border-top:1px solid #eee;display:flex;gap:8px;justify-content:flex-end}
.dialog h3{margin:8px 0 6px}
.dialog p{margin:4px 0 10px;color:#555}
.dialog textarea{width:100%;height:120px;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:14px;line-height:1.6;resize:vertical}
.dialog .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
hr.sep{border:none;border-top:1px dashed #e5e5e5;margin:8px 0}
.histItem{border:1px solid #eee;border-radius:10px;padding:8px;margin:8px 0;background:#fafafa}
.histHead{display:flex;justify-content:space-between;align-items:center;gap:8px}
.histBtns{display:flex;gap:6px}
.small{font-size:12px;color:#666}
pre.preview{background:#f7f7f7;border:1px solid #eee;padding:8px;border-radius:8px;white-space:pre-wrap;max-height:40vh;overflow:auto}
</style>

<div class="wrap">
  <div class="panel">
    <div class="head">
      <span data-i18n="leftTitle">å·¦æ ï½œé«˜äº®æ—¥å¿—ï¼ˆå‘½ä¸­/ç–‘ä¼¼ä¼šå•ç‹¬æˆè¡Œï¼Œå¯ç‚¹å‡»ï¼‰</span>
      <button id="pasteBtn" class="secondary" data-i18n="btnPaste">ç²˜è´´æ—¥å¿—</button>
      <button id="appendBtn" class="secondary" data-i18n="btnAppend">è¿½åŠ ç²˜è´´</button>
      <button id="insertBtn" class="secondary" data-i18n="btnInsert">æ’å…¥ç²˜è´´</button>
      <button id="editBtn" class="secondary" data-i18n="btnEdit">ä¿®æ”¹æŒ‡å®šè¡Œ</button>
      <button id="delBtn" class="secondary" data-i18n="btnDelete">åˆ é™¤æœ«è¡Œ</button>
      <button id="reparseBtn" class="secondary" data-i18n="btnReparse">é‡æ–°è§£æ</button>
    </div>
    <div class="body">
      <div class="legend" id="legend"></div>
      <div id="content" class="content"></div>
    </div>
  </div>

  <div class="panel">
    <div class="head">
      <span data-i18n="rightTitle">å³æ ï½œæ‰“æ ‡ç­¾ä¸æ±‡æ€»</span>
      <button id="kwBtn" class="secondary" data-i18n="btnKw">å®šä¹‰å…³é”®è¯</button>
      <button id="saveSnapBtn" class="secondary" data-i18n="btnSave">ä¿å­˜æ ‡ç­¾</button>
      <button id="histBtn" class="secondary" data-i18n="btnHist">å†å²</button>
      <button id="importBtn" class="secondary" data-i18n="btnImport">å¯¼å…¥JSON</button>
      <button id="exportBtn" class="secondary" data-i18n="btnExport">å¯¼å‡ºJSON</button>
      <button id="langBtn" class="secondary" data-i18n="btnLang">è¯­è¨€</button>
      <button id="helpBtn" class="secondary" data-i18n="btnHelp">å¸®åŠ©</button>
    </div>
    <div class="body">
      <div class="tools">
        <input id="c1" list="dl1" type="text" data-i18n-ph="phC1" placeholder="ä¸€çº§æ ‡é¢˜ï¼ˆç‚¹å‡»å¯é€‰å†å²ï¼‰">
        <datalist id="dl1"></datalist>
        <input id="c2" list="dl2" type="text" data-i18n-ph="phC2" placeholder="äºŒçº§æ ‡é¢˜ï¼ˆç‚¹å‡»å¯é€‰å†å²ï¼‰">
        <datalist id="dl2"></datalist>
        <input id="overMin" type="number" step="0.01" data-i18n-ph="phOver" placeholder="è¦†ç›–åˆ†é’Ÿï¼ˆå¯é€‰ï¼‰">
        <label class="cb"><input id="byDate" type="checkbox" checked> <span data-i18n="byDate">æŒ‰æ—¥æœŸåˆ†å‰²</span></label>
        <label class="cb"><span data-i18n="show">æ˜¾ç¤ºï¼š</span>
          <select id="c2Mode">
            <option value="uniq" selected data-i18n="optUniq">ä»…å»é‡å¤ï¼ˆæ¢è¡Œåˆ—å‡ºï¼‰</option>
            <option value="dup" data-i18n="optDup">ä»…å¸¦é‡å¤ï¼ˆåŠ å·è¿æ¥ï¼‰</option>
            <option value="both" data-i18n="optBoth">å¸¦é‡å¤ + å»é‡å¤</option>
          </select>
        </label>
        <button id="tagBtn" disabled data-i18n="btnTag">æ‰“æ ‡ç­¾</button>
        <button id="sumBtn" class="secondary" data-i18n="btnSum">æ±‡æ€»</button>
        <button id="clearBtn" class="secondary" data-i18n="btnClear">æ¸…ç©º</button>
      </div>
      <div class="row muted"><span data-i18n="curEntry">å½“å‰æ¡ç›®ï¼š</span><span id="curText"></span></div>
      <div class="row muted"><span data-i18n="curMeta">å…ƒä¿¡æ¯ï¼š</span><span id="curMeta"></span></div>
      <hr class="sep">
      <div id="sumArea" class="list"></div>
    </div>
  </div>
</div>

<!-- ç²˜è´´å¼¹çª— -->
<div id="pasteModal" class="modal hidden">
  <div class="dialog">
    <div class="title" id="pasteTitle">ç²˜è´´ä½ çš„å¼¹å¹•æ—¥å¿—</div>
    <div class="cont">
      <textarea id="pasteInput" data-i18n-ph="phPaste" placeholder="æŠŠæ•´æ®µæ—¥å¿—ç²˜è´´åˆ°è¿™é‡Œâ€¦"></textarea>
    </div>
    <div class="actions">
      <button id="cancelPaste" class="secondary" data-i18n="cancel">å–æ¶ˆ</button>
      <button id="parseBtn" data-i18n="parse">è§£æ</button>
    </div>
  </div>
</div>

<!-- æ’å…¥ç²˜è´´å¼¹çª— -->
<div id="insertModal" class="modal hidden">
  <div class="dialog">
    <div class="title" data-i18n="insTitle">æ’å…¥ç²˜è´´ï¼ˆæŒ‡å®šä»å€’æ•°ç¬¬ N è¡Œä¹‹å‰æ’å…¥ï¼‰</div>
    <div class="cont">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <label class="cb" style="border:none;padding:0">
          <span data-i18n="insTailLabel">ä»å€’æ•°ç¬¬</span>
          <input id="insTail" type="number" min="0" value="0" style="width:100px">
          <span data-i18n="insTailUnit">è¡Œä¹‹å‰æ’å…¥</span>
        </label>
        <span class="small" id="insInfo"></span>
      </div>
      <div style="margin-top:8px" class="small" data-i18n="insPreviewHint">å°†ä»¥ä¸‹æœ«å°¾è¡Œä½œä¸ºå‚ç…§ï¼ˆé¢„è§ˆï¼‰ï¼š</div>
      <pre id="insPreview" class="preview"></pre>
      <hr class="sep">
      <div>
        <b data-i18n="insTextLabel">ç²˜è´´å†…å®¹ï¼š</b>
        <textarea id="insText" placeholder="å°†è¦æ’å…¥çš„å¤šè¡Œæ–‡æœ¬â€¦"></textarea>
      </div>
    </div>
    <div class="actions">
      <button id="insCancel" class="secondary" data-i18n="cancel">å–æ¶ˆ</button>
      <button id="insDo" data-i18n="insDo">æ’å…¥</button>
    </div>
  </div>
</div>

<!-- åˆ é™¤æœ«è¡Œå¼¹çª— -->
<div id="delModal" class="modal hidden">
  <div class="dialog">
    <div class="title" data-i18n="delTitle">åˆ é™¤æœ«å°¾è¡Œ</div>
    <div class="cont">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <label class="cb" style="border:none;padding:0">
          <span data-i18n="delHowMany">åˆ é™¤è¡Œæ•°</span>ï¼š
          <input id="delCount" type="number" min="1" value="1" style="width:100px">
        </label>
        <span class="small" id="delInfo"></span>
      </div>
      <div style="margin-top:8px" class="small" data-i18n="delPreviewHint">å°†åˆ é™¤ä»¥ä¸‹è¡Œï¼ˆé¢„è§ˆï¼‰ï¼š</div>
      <pre id="delPreview" class="preview"></pre>
    </div>
    <div class="actions">
      <button id="delCancel" class="secondary" data-i18n="cancel">å–æ¶ˆ</button>
      <button id="delDo" data-i18n="delDo">åˆ é™¤</button>
    </div>
  </div>
</div>

<!-- å…³é”®è¯å®šä¹‰å¼¹çª— -->
<div id="kwModal" class="modal hidden">
  <div class="dialog">
    <div class="title" data-i18n="kwTitle">å®šä¹‰å…³é”®è¯ä¸åˆ†é’Ÿè¡¨è¾¾å¼</div>
    <div class="cont">
      <h3 data-i18n="kwBlueH3">ä¸€ã€æ ‡è“è§„åˆ™ï¼ˆå†³å®šå‘½ä¸­æ¡ç›®ä¸åˆ†é’Ÿè§£æï¼‰</h3>
      <p data-i18n="kwBlueP">ä¸€è¡Œä¸­åŒæ—¶å‡ºç°ã€å·¦ä¾§å…³é”®å­—ã€‘ä¸ã€åˆ†é’Ÿè¡¨è¾¾å¼ + åç¼€ã€‘ï¼Œå³è§†ä¸ºå‘½ä¸­"æ ‡è“"æ¡ç›®å¹¶è§£æåˆ†é’Ÿã€‚</p>
      <div class="grid">
        <div>
          <b data-i18n="kwBlueTags">å·¦ä¾§å…³é”®å­—ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</b>
          <textarea id="kw_blue_tags" placeholder="ã€å­¦ä¹ æ—¶é—´ã€‘&#10;ã€å·¥ä½œæ—¶é—´ã€‘"></textarea>
        </div>
        <div>
          <b data-i18n="kwBlueExpr">åˆ†é’Ÿè¡¨è¾¾å¼ï¼ˆæ­£åˆ™ï¼Œä¸å«åç¼€ï¼‰</b>
          <textarea id="kw_blue_expr" placeholder="[0-9]+(?:\\.[0-9]+)?(?:\\s*\\+\\s*[0-9]+(?:\\.[0-9]+)?)*"></textarea>
          <div style="margin-top:6px">
            <span data-i18n="kwBlueSuffix">åç¼€ï¼š</span>
            <input id="kw_blue_suffix" type="text" style="min-width:160px" placeholder="åˆ†é’Ÿ">
          </div>
        </div>
      </div>
      <hr class="sep">
      <h3 data-i18n="kwGreenH3">äºŒã€æ ‡ç»¿è§„åˆ™ï¼ˆæ™®é€šå…³é”®è¯é«˜äº®ï¼‰</h3>
      <div class="grid">
        <div>
          <b data-i18n="kwGreenKw">å…³é”®å­—ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</b>
          <textarea id="kw_green_words" placeholder="å­¦ä¹ æ—¶é—´&#10;å·¥ä½œæ—¶é—´"></textarea>
        </div>
        <div>
          <label class="cb" style="margin-top:8px">
            <input id="kw_green_only_when_no_blue" type="checkbox">
            <span data-i18n="kwGreenChk">ä»…åœ¨æœªå‘½ä¸­"æ ‡è“"æ—¶æ‰æ ‡ç»¿ï¼ˆæ¨èï¼‰</span>
          </label>
        </div>
      </div>
    </div>
    <div class="actions">
      <button id="kwReset" class="secondary" data-i18n="reset">æ¢å¤é»˜è®¤</button>
      <button id="kwCancel" class="secondary" data-i18n="cancel">å–æ¶ˆ</button>
      <button id="kwSave" data-i18n="saveApply">ä¿å­˜å¹¶åº”ç”¨</button>
    </div>
  </div>
</div>

<!-- å†å² / ç‰ˆæœ¬å›æº¯ -->
<div id="histModal" class="modal hidden">
  <div class="dialog">
    <div class="title" data-i18n="histTitle">å†å²ç‰ˆæœ¬ï¼ˆæœ€è¿‘ 5 ä¸ªï¼‰</div>
    <div class="cont" id="histBody"></div>
    <div class="actions">
      <button id="closeHist" data-i18n="close">å…³é—­</button>
    </div>
  </div>
</div>

<!-- å¸®åŠ©å¼¹çª— -->
<div id="helpModal" class="modal hidden">
  <div class="dialog">
    <div class="title" data-i18n="helpTitle">å¸®åŠ© / ç¤ºä¾‹</div>
    <div class="cont" id="helpBody"></div>
    <div class="actions">
      <button id="loadSample" class="secondary" data-i18n="loadSample">è½½å…¥ç¤ºä¾‹æ—¥å¿—</button>
      <button id="closeHelp" data-i18n="close">å…³é—­</button>
    </div>
  </div>
</div>

<!-- ä¿®æ”¹æŒ‡å®šè¡Œå¼¹çª— -->
<div id="editModal" class="modal hidden">
  <div class="dialog">
    <div class="title" data-i18n="editTitle">ä¿®æ”¹æŒ‡å®šè¡Œ</div>
    <div class="cont">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <label class="cb" style="border:none;padding:0">
          <span data-i18n="editLineNum">ç›®æ ‡è¡Œå·</span>ï¼š
          <input id="editLine" type="number" min="1" value="1" style="width:120px">
        </label>
        <span class="small" id="editInfo"></span>
      </div>
      <div style="margin-top:8px" class="small" data-i18n="editPreviewHint">é¢„è§ˆï¼šæ˜¾ç¤ºè¯¥è¡ŒåŠå…¶åçš„è¡Œ</div>
      <pre id="editPreview" class="preview"></pre>
      <hr class="sep">
      <div>
        <b data-i18n="editTextLabel">ç¼–è¾‘å†…å®¹ï¼ˆå¯å¤šè¡Œï¼Œæ›¿æ¢åŸè¡Œï¼‰</b>
        <textarea id="editArea"></textarea>
      </div>
    </div>
    <div class="actions">
      <button id="editCancel" class="secondary" data-i18n="cancel">å–æ¶ˆ</button>
      <button id="editApply" data-i18n="editApply">åº”ç”¨ä¿®æ”¹</button>
    </div>
  </div>
</div>

<script>
/* ===== LocalStorage Keysï¼ˆä¿æŒä¸å˜ï¼‰ ===== */
const RAW_KEY ='annot_raw_text';
const SUG1_KEY='annot_c1_suggestions';
const SUG2_KEY='annot_c2_suggestions';
const MAP_KEY ='annot_label_map';
const CFG_KEY ='annot_cfg';
const LANG_KEY='annot_lang';
const VER_KEY ='annot_versions';
const VER_AUTO_KEY='annot_versions_auto';

/* ===== i18n ===== */
const i18n = {
  zh: {
    leftTitle:'å·¦æ ï½œé«˜äº®æ—¥å¿—ï¼ˆå‘½ä¸­/ç–‘ä¼¼ä¼šå•ç‹¬æˆè¡Œï¼Œå¯ç‚¹å‡»ï¼‰',
    rightTitle:'å³æ ï½œæ‰“æ ‡ç­¾ä¸æ±‡æ€»',
    legend:'é«˜äº®ï¼š<span class="blue">ã€â€¦æ—¶é—´ã€‘â€¦</span>ï½œ<span class="green">å­¦ä¹ /å·¥ä½œæ—¶é—´</span>ï½œ<span class="cyan">NNâ€¦åˆ†é’Ÿ</span> Â· è“/ç–‘ä¼¼æ¡ç›®å¯ç‚¹é€‰åæ‰“"ä¸€çº§/äºŒçº§"æ ‡ç­¾ï¼Œå†ç‚¹ã€Œæ±‡æ€»ã€ã€‚',
    btnPaste:'ç²˜è´´æ—¥å¿—', btnAppend:'è¿½åŠ ç²˜è´´', btnInsert:'æ’å…¥ç²˜è´´', btnReparse:'é‡æ–°è§£æ', btnDelete:'åˆ é™¤æœ«è¡Œ',
    btnKw:'å®šä¹‰å…³é”®è¯', btnLang:'è¯­è¨€', btnHelp:'å¸®åŠ©',
    btnSave:'ä¿å­˜æ ‡ç­¾', btnHist:'å†å²',
    btnImport:'å¯¼å…¥JSON', btnExport:'å¯¼å‡ºJSON',
    btnEdit:'ä¿®æ”¹æŒ‡å®šè¡Œ',
    phC1:'ä¸€çº§æ ‡é¢˜ï¼ˆç‚¹å‡»å¯é€‰å†å²ï¼‰', phC2:'äºŒçº§æ ‡é¢˜ï¼ˆç‚¹å‡»å¯é€‰å†å²ï¼‰', phOver:'è¦†ç›–åˆ†é’Ÿï¼ˆå¯é€‰ï¼‰',
    byDate:'æŒ‰æ—¥æœŸåˆ†å‰²', show:'æ˜¾ç¤ºï¼š',
    optUniq:'ä»…å»é‡å¤ï¼ˆæ¢è¡Œåˆ—å‡ºï¼‰', optDup:'ä»…å¸¦é‡å¤ï¼ˆåŠ å·è¿æ¥ï¼‰', optBoth:'å¸¦é‡å¤ + å»é‡å¤',
    btnTag:'æ‰“æ ‡ç­¾', btnSum:'æ±‡æ€»', btnClear:'æ¸…ç©º',
    curEntry:'å½“å‰æ¡ç›®ï¼š', curMeta:'å…ƒä¿¡æ¯ï¼š',
    pasteTitle:'ç²˜è´´ä½ çš„å¼¹å¹•æ—¥å¿—', pasteTitleAppend:'è¿½åŠ ç²˜è´´åˆ°ç°æœ‰æ—¥å¿—', phPaste:'æŠŠæ•´æ®µæ—¥å¿—ç²˜è´´åˆ°è¿™é‡Œâ€¦',
    cancel:'å–æ¶ˆ', parse:'è§£æ',
    kwTitle:'å®šä¹‰å…³é”®è¯ä¸åˆ†é’Ÿè¡¨è¾¾å¼',
    kwBlueH3:'ä¸€ã€æ ‡è“è§„åˆ™ï¼ˆå†³å®šå‘½ä¸­æ¡ç›®ä¸åˆ†é’Ÿè§£æï¼‰',
    kwBlueP:'ä¸€è¡Œä¸­åŒæ—¶å‡ºç°ã€å·¦ä¾§å…³é”®å­—ã€‘ä¸ã€åˆ†é’Ÿè¡¨è¾¾å¼ + åç¼€ã€‘ï¼Œå³è§†ä¸ºå‘½ä¸­"æ ‡è“"æ¡ç›®å¹¶è§£æåˆ†é’Ÿã€‚',
    kwBlueTags:'å·¦ä¾§å…³é”®å­—ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰', kwBlueExpr:'åˆ†é’Ÿè¡¨è¾¾å¼ï¼ˆæ­£åˆ™ï¼Œä¸å«åç¼€ï¼‰', kwBlueSuffix:'åç¼€ï¼š',
    kwGreenH3:'äºŒã€æ ‡ç»¿è§„åˆ™ï¼ˆæ™®é€šå…³é”®è¯é«˜äº®ï¼‰', kwGreenKw:'å…³é”®å­—ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰', kwGreenChk:'ä»…åœ¨æœªå‘½ä¸­"æ ‡è“"æ—¶æ‰æ ‡ç»¿ï¼ˆæ¨èï¼‰',
    reset:'æ¢å¤é»˜è®¤', saveApply:'ä¿å­˜å¹¶åº”ç”¨',
    helpTitle:'å¸®åŠ© / ç¤ºä¾‹', loadSample:'è½½å…¥ç¤ºä¾‹æ—¥å¿—', close:'å…³é—­',
    minutes:'åˆ†é’Ÿ', dateUnk:'æœªè¯†åˆ«æ—¥æœŸ', dateNote:'(ä»…è¯†åˆ«è¡Œé¦–æ—¶é—´æ ‡è®°)',
    sumDup:'äºŒçº§ï¼ˆå¸¦é‡å¤ï¼‰ï¼š', sumUniqHdr:'äºŒçº§ï¼ˆå»é‡å¤ï¼‰ï¼š',
    total:'æ€»åˆ†é’Ÿï¼š', dayTotal:'å½“æ—¥æ€»æ—¶é—´ï¼š',
    confirmReparse:'é‡æ–°è§£æä¼šæ¸…ç©ºå·²æ‰“çš„æ ‡ç­¾ï¼Œç»§ç»­å—ï¼Ÿ',
    confirmClear:'ä»…æ¸…ç©ºæ ‡ç­¾ï¼ˆannot_label_mapï¼‰ï¼ŒåŸæ–‡ä¸å†å²æ ‡é¢˜ä¿ç•™ã€‚ç¡®å®šï¼Ÿ',
    alertNeedTitles:'è¯·å¡«å†™ä¸€çº§ä¸äºŒçº§æ ‡é¢˜',
    alertOverNum:'è¦†ç›–åˆ†é’Ÿéœ€ä¸ºæ•°å­—',
    metaDate:'æ—¥æœŸ', metaSus:'ç–‘ä¼¼', metaMin:'åˆ†é’Ÿ',
    histTitle:'å†å²',
    histEmpty:'æš‚æ— æ‰‹åŠ¨å¿«ç…§ã€‚ç”¨"ä¿å­˜æ ‡ç­¾"ä¿å­˜ä¸€ä¸ªå¿«ç…§ã€‚',
    histSnap:'å¿«ç…§',
    histCounts:'æ—¥å¿—è¡Œ/æ ‡ç­¾æ¡ç›®/ä¸€çº§æ ‡é¢˜æ•°/äºŒçº§æ ‡é¢˜æ•°',
    btnRestore:'æ¢å¤æ­¤ç‰ˆæœ¬', /* btnExport å·²æœ‰ */
    toastSaved:'å·²ä¿å­˜å½“å‰ç‰ˆæœ¬åˆ°å†å²ï¼ˆæœ€å¤šä¿ç•™ 5 ä¸ªï¼‰ã€‚',
    histAutoTitle:'è‡ªåŠ¨ä¿å­˜ï¼ˆæœ€è¿‘ 2ï¼‰',
    histManualTitle:'æ‰‹åŠ¨ä¿å­˜ï¼ˆæœ€è¿‘ 5ï¼‰',
    // åˆ é™¤æœ«è¡Œ
    delTitle:'åˆ é™¤æœ«å°¾è¡Œ',
    delHowMany:'åˆ é™¤è¡Œæ•°',
    delPreviewHint:'å°†åˆ é™¤ä»¥ä¸‹è¡Œï¼ˆé¢„è§ˆï¼‰ï¼š',
    delDo:'åˆ é™¤',
    delInfo:'å½“å‰æ—¥å¿—å…± {n} è¡Œ',
    delConfirm:'ç¡®è®¤åˆ é™¤æœ€å {n} è¡Œï¼Ÿ',
    delNone:'å½“å‰æ²¡æœ‰å¯åˆ é™¤çš„æ—¥å¿—ã€‚',
    // æ’å…¥ç²˜è´´
    insTitle:'æ’å…¥ç²˜è´´ï¼ˆæŒ‡å®šä»å€’æ•°ç¬¬ N è¡Œä¹‹å‰æ’å…¥ï¼‰',
    insTailLabel:'ä»å€’æ•°ç¬¬', insTailUnit:'è¡Œä¹‹å‰æ’å…¥',
    insPreviewHint:'å°†ä»¥ä¸‹æœ«å°¾è¡Œä½œä¸ºå‚ç…§ï¼ˆé¢„è§ˆï¼‰ï¼š',
    insTextLabel:'ç²˜è´´å†…å®¹ï¼š',
    insDo:'æ’å…¥',
    insInfoTpl:'æ€»è¡Œæ•° {total} Â· æ’å…¥ä½ç½®ï¼šç¬¬ {pos} è¡Œä¹‹å Â· ç²˜è´´è¡Œæ•° {addLines} Â· é¢„è®¡æ–°å¢æ¡ç›® {addEntries}',
    insNoRaw:'å½“å‰æ²¡æœ‰æ—¥å¿—ï¼Œè¯·å…ˆç²˜è´´æˆ–å¯¼å…¥ã€‚',
    // ä¿®æ”¹æŒ‡å®šè¡Œ
    editTitle:'ä¿®æ”¹æŒ‡å®šè¡Œ',
    editLineNum:'ç›®æ ‡è¡Œå·',
    editPreviewHint:'é¢„è§ˆï¼šæ˜¾ç¤ºè¯¥è¡ŒåŠå…¶åçš„è¡Œ',
    editTextLabel:'ç¼–è¾‘å†…å®¹ï¼ˆå¯å¤šè¡Œï¼Œæ›¿æ¢åŸè¡Œï¼‰',
    editApply:'åº”ç”¨ä¿®æ”¹',
  },
  en: {
    leftTitle:'Leftï½œHighlighted log (hits/suspects break into lines, clickable)',
    rightTitle:'Rightï½œTag & Summarize',
    legend:'Highlight: <span class="blue">[â€¦time] â€¦</span> | <span class="green">Study/Work time</span> | <span class="cyan">NNâ€¦ minutes</span> Â· Click blue/suspect rows to assign L1/L2, then "Summarize".',
    btnPaste:'Paste', btnAppend:'Append', btnInsert:'Insert', btnReparse:'Reparse', btnDelete:'Delete tail',
    btnKw:'Define Keywords', btnLang:'Language', btnHelp:'Help',
    btnSave:'Save Tags', btnHist:'History',
    btnImport:'Import JSON', btnExport:'Export',
    btnEdit:'Edit line',
    phC1:'Level-1 title (click for history)', phC2:'Level-2 title (click for history)', phOver:'Override minutes (optional)',
    byDate:'Split by date', show:'Show:',
    optUniq:'Unique only (one per line)', optDup:'With duplicates (+ joined)', optBoth:'Both',
    btnTag:'Tag', btnSum:'Summarize', btnClear:'Clear',
    curEntry:'Current:', curMeta:'Meta:',
    pasteTitle:'Paste your log', pasteTitleAppend:'Append to existing log', phPaste:'Paste the whole log hereâ€¦',
    cancel:'Cancel', parse:'Parse',
    kwTitle:'Define keywords & minute pattern',
    kwBlueH3:'A) Blue rules (hit & minute parsing)',
    kwBlueP:'A line is "blue-hit" when BOTH a left keyword and a [minute-expression + suffix] appear.',
    kwBlueTags:'Left keywords (one per line)', kwBlueExpr:'Minute expression (regex, no suffix)', kwBlueSuffix:'Suffix:',
    kwGreenH3:'B) Green rules (plain keywords highlight)', kwGreenKw:'Keywords (one per line)', kwGreenChk:'Only when not blue-hit (recommended)',
    reset:'Reset', saveApply:'Save & Apply',
    helpTitle:'Help / Sample', loadSample:'Load sample', close:'Close',
    minutes:'minutes', dateUnk:'Unrecognized date', dateNote:'(only detects date at line start)',
    sumDup:'Level-2 (with duplicates): ', sumUniqHdr:'Level-2 (unique): ',
    total:'Group total:', dayTotal:'Day total:',
    confirmReparse:'Reparse will clear existing labels. Continue?',
    confirmClear:'Clear labels only (annot_label_map). Raw & history kept. Proceed?',
    alertNeedTitles:'Please fill Level-1 and Level-2 titles',
    alertOverNum:'Override minutes must be a number',
    metaDate:'Date', metaSus:'suspect', metaMin:'minutes',
    histTitle:'History',
    histEmpty:'No manual snapshots yet. Use "Save Tags" to create one.',
    histSnap:'Snapshot',
    histCounts:'Raw lines / labeled entries / L1 count / L2 count',
    btnRestore:'Restore',
    toastSaved:'Current version saved (keeping last 5).',
    histAutoTitle:'Auto-saved (last 2)',
    histManualTitle:'Manual (last 5)',
    // åˆ é™¤æœ«è¡Œ
    delTitle:'Delete tail lines',
    delHowMany:'Lines to remove',
    delPreviewHint:'These lines will be removed (preview):',
    delDo:'Delete',
    delInfo:'Current log has {n} lines',
    delConfirm:'Delete the last {n} lines?',
    delNone:'No log to delete.',
    // æ’å…¥ç²˜è´´
    insTitle:'Insert paste (before the last N lines)',
    insTailLabel:'Insert before last', insTailUnit:'lines',
    insPreviewHint:'Preview of tail lines:',
    insTextLabel:'Text to insert:',
    insDo:'Insert',
    insInfoTpl:'Total {total} lines Â· Insert after line {pos} Â· Inserting {addLines} lines Â· Estimated new entries {addEntries}',
    insNoRaw:'No log yet. Paste or import first.',
    // ä¿®æ”¹æŒ‡å®šè¡Œ
    editTitle:'Edit a specific line',
    editLineNum:'Target line #',
    editPreviewHint:'Preview: show this line and everything after it',
    editTextLabel:'Edited text (may be multi-line; replaces the original line)',
    editApply:'Apply',
  }
};
let lang = localStorage.getItem(LANG_KEY)||'zh';
function t(k){ return (i18n[lang]&&i18n[lang][k])||k; }
function applyI18n(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{ el.textContent = t(el.getAttribute('data-i18n')); });
  document.querySelectorAll('[data-i18n-ph]').forEach(el=>{ el.setAttribute('placeholder', t(el.getAttribute('data-i18n-ph'))); });
  document.getElementById('legend').innerHTML = t('legend');
  const pasteTitle = document.getElementById('pasteTitle');
  if(pasteTitle){ pasteTitle.textContent = t(appendMode?'pasteTitleAppend':'pasteTitle'); }
}

/* ===== é»˜è®¤é…ç½® ===== */
const defaultCfg = {
  blue: { tags: ['ã€å­¦ä¹ æ—¶é—´ã€‘','ã€å·¥ä½œæ—¶é—´ã€‘'], minuteExpr: '[0-9]+(?:\\.[0-9]+)?(?:\\s*\\+\\s*[0-9]+(?:\\.[0-9]+)?)*', suffix: 'åˆ†é’Ÿ' },
  green:{ keywords: ['å­¦ä¹ æ—¶é—´','å·¥ä½œæ—¶é—´'], onlyWhenNoBlue: true }
};

/* ===== å·¥å…· ===== */
function getLS(k,def){ try{ return JSON.parse(localStorage.getItem(k)||def); }catch(e){ return JSON.parse(def); } }
function setLS(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function fmt(n){ const v=Number(n||0); return Number.isInteger(v)?String(v):v.toFixed(2).replace(/\.00$/,'').replace(/(\.\d)0$/,'$1'); }
function esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escReg(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');}
function nowTs(){ return Date.now(); }
function tsFmt(ts){ const d=new Date(ts); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0'); return `${y}-${m}-${da} ${hh}:${mm}`; }

/* ===== é…ç½®ç¼–è¯‘ ===== */
let cfg = Object.assign({}, defaultCfg, getLS(CFG_KEY, 'null')||{});
function saveCfg(){ setLS(CFG_KEY, cfg); compileCfg(); scheduleAutoSave('cfg_save'); }
let reBlueLine=null, reBlueTags=null, reGreenKW=null, reBlueMinute=null, reMinuteGlobal=null;
function compileCfg(){
  const tagsAlt = (cfg.blue.tags||[]).map(escReg).join('|') || '(?!)';
  const kwAlt   = (cfg.green.keywords||[]).map(escReg).join('|') || '(?!)';
  const minutePart = `(${cfg.blue.minuteExpr})\\s*${escReg(cfg.blue.suffix||'åˆ†é’Ÿ')}`;
  reBlueLine     = new RegExp(`(?:${tagsAlt})[\\s\\S]*?${minutePart}`, 'i');
  reBlueTags     = new RegExp(`(?:${tagsAlt})`, 'i');
  reGreenKW      = new RegExp(`(?:${kwAlt})`, 'g');
  reBlueMinute   = new RegExp(`${minutePart}`, 'i');
  reMinuteGlobal = new RegExp(`${cfg.blue.minuteExpr}\\s*${escReg(cfg.blue.suffix||'åˆ†é’Ÿ')}`, 'g');
}
compileCfg();

/* ===== å»ºè®®ã€æ ‡ç­¾ ===== */
const c1Sug = new Set(getLS(SUG1_KEY,'[]'));
const c2Sug = new Set(getLS(SUG2_KEY,'[]'));
let labelMap = getLS(MAP_KEY,'{}');
function saveMap(){ setLS(MAP_KEY,labelMap); }

/* ===== æ—¥æœŸ ===== */
const monMap={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,sept:9,oct:10,nov:11,dec:12};
function pad(n){return String(n).padStart(2,'0');}
function normYMD(y,m,d){ return `${y}-${pad(m)}-${pad(d)}`; }
function findDateToken(line){
  let m=line.match(/^\s*\d{1,2}:\d{2},\s*(Jan(?:uary)?|Feb(?:ruary)?|Mar(?:ch)?|Apr(?:il)?|May|Jun(?:e)?|Jul(?:y)?|Aug(?:ust)?|Sep(?:tember)?|Sept|Oct(?:ober)?|Nov(?:ember)?|Dec(?:ember)?)\s+(\d{1,2}),\s*(\d{4})/i);
  if(m){ const mon={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,sept:9,oct:10,nov:11,dec:12}[m[1].slice(0,3).toLowerCase()]; return normYMD(m[3],mon,m[2]); }
  m=line.match(/^\s*\d{1,2}:\d{2},\s*(20\d{2})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
  if(m){ return normYMD(m[1],m[2],m[3]); }
  return null;
}
const weekdayZh=['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'];
const weekdayEn=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
function weekdayLabel(ymd){
  const u=/^(\d{4})-(\d{2})-(\d{2})$/.exec(ymd); if(!u) return '';
  const dt=new Date(+u[1],+u[2]-1,+u[3]); const w=dt.getDay();
  return (lang==='zh'?weekdayZh:weekdayEn)[w]||'';
}
function fmtWeekParen(ymd){ const w=weekdayLabel(ymd); return w?(lang==='zh'?`ï¼ˆ${w}ï¼‰`:` (${w})`):''; }

/* ===== æ¡ç›®åˆ¤å®š & åˆ†é’Ÿè§£æ ===== */
function isEntryLine(line){
  const hasBlue = reBlueLine.test(line);
  const hasKW = reGreenKW.test(line); reGreenKW.lastIndex = 0;
  const hasBracket = reBlueTags.test(line);
  return hasBlue || (hasKW && !hasBracket);
}
function parseMinutesFromBlue(text){
  const mLine = text.match(reBlueLine);
  if(mLine){
    const m = mLine[0].match(reBlueMinute);
    if(m){
      const expr = (m[1]||'').split('+').map(s=>parseFloat(s)).filter(x=>!isNaN(x));
      return {min: expr.reduce((a,b)=>a+b,0), exact:true};
    }
  }
  return {min:0, exact:false};
}

/* ===== é«˜äº®æ¸²æŸ“ ===== */
function hiInline(s, blueHit=false){
  let t=esc(s);
  t=t.replace(/^(\s*\d{1,2}:\d{2})(,?\s*(?:[A-Za-z]{3,9}\s+\d{1,2},\s*\d{4}|\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥)?)/,'<span class="cyan">$1</span>$2');
  if(cfg.blue.tags && cfg.blue.tags.length){
    const alt=cfg.blue.tags.map(escReg).join('|');
    t=t.replace(new RegExp(`(${alt})`,'g'),'<span class="blue">$1</span>');
  }
  const doGreen=!(cfg.green.onlyWhenNoBlue && blueHit);
  if(doGreen && cfg.green.keywords && cfg.green.keywords.length){
    try{
      const alt=cfg.green.keywords.map(escReg).join('|');
      t=t.replace(new RegExp(`(?<!ã€)(${alt})(?!ã€‘)`,'g'),'<span class="green">$1</span>');
    }catch(e){
      const alt=cfg.green.keywords.map(escReg).join('|');
      t=t.replace(new RegExp(`(${alt})`,'g'),'<span class="green">$1</span>');
    }
  }
  t=t.replace(reMinuteGlobal,m=>`<span class="cyan">${m}</span>`);
  return t;
}
function render(raw){
  const cont=document.getElementById('content'); cont.innerHTML='';
  const lines=(raw||'').replace(/\r\n?/g,'\n').split('\n');
  const entryEls=[]; let idx=0; let currentDate=t('dateUnk');
  lines.forEach(line=>{
    const d=findDateToken(line); if(d) currentDate=d;
    const hasBlue=reBlueLine.test(line);
    const hasKW=reGreenKW.test(line); reGreenKW.lastIndex = 0;
    const hasBracket=reBlueTags.test(line);

    if(hasBlue || (hasKW && !hasBracket)){
      const div=document.createElement('div');
      div.className='entry'+(hasBlue?' blue':' suspect');
      div.innerHTML = hiInline(line, hasBlue);
      div.dataset.id='e'+(++idx);
      div.dataset.kind=/å­¦ä¹ |study/i.test(line)?'å­¦ä¹ ':(/å·¥ä½œ|work/i.test(line)?'å·¥ä½œ':'æœªçŸ¥');
      const pm=hasBlue?parseMinutesFromBlue(line):{min:0,exact:false};
      div.dataset.minutes=String(pm.min||0);
      if(!pm.exact) div.classList.add('suspect');
      div.dataset.date=currentDate;

      const rec=labelMap[div.dataset.id];
      if(rec){
        const b=document.createElement('span'); b.className='badge';
        b.textContent=rec.c1+' / '+rec.c2+(rec.overMin?(' Â· '+rec.overMin+'m'):'');
        div.appendChild(b);
      }
      cont.appendChild(div); entryEls.push(div);
    }else{
      const p=document.createElement('div'); p.className='line';
      p.innerHTML=hiInline(line,reBlueLine.test(line));
      cont.appendChild(p);
    }
  });

  let current=null;
  entryEls.forEach(el=>{
    el.addEventListener('click',()=>{
      if(current) current.classList.remove('selected');
      current=el; el.classList.add('selected');
      document.getElementById('curText').textContent = el.textContent.slice(0,160);
      const meta=[`#${el.dataset.id}`, el.dataset.kind, `${el.dataset.minutes} ${t('minutes')}`, `${t('metaDate')}ï¼š${el.dataset.date}`];
      if(el.classList.contains('suspect')) meta.push(`Â· ${t('metaSus')}`);
      document.getElementById('curMeta').textContent = meta.join(' Â· ');
      const rec = labelMap[el.dataset.id];
      document.getElementById('c1').value = rec?rec.c1:'';
      document.getElementById('c2').value = rec?rec.c2:'';
      document.getElementById('overMin').value = rec&&rec.overMin?rec.overMin:'';
      document.getElementById('tagBtn').disabled=false;
    });
  });
}

/* ===== æ±‡æ€» ===== */
function summarize(byDate=true){
  const entries=Array.from(document.querySelectorAll('.entry'));
  const bucketByDate={}, allByC1={};
  entries.forEach(el=>{
    const id=el.dataset.id; const rec=labelMap[id]; if(!rec) return;
    const baseMin=parseFloat(el.dataset.minutes)||0;
    const m=rec.overMin!=null?rec.overMin:baseMin;
    const name=(rec.c2&&rec.c2.trim())?rec.c2.trim():'ï¼ˆæœªå‘½åï¼‰';
    if(byDate){
      const d=el.dataset.date||t('dateUnk');
      if(!bucketByDate[d]) bucketByDate[d]={};
      const g=bucketByDate[d][rec.c1]||(bucketByDate[d][rec.c1]={mins:0,secList:[]});
      g.mins+=m; g.secList.push({name,m});
    }else{
      const g=allByC1[rec.c1]||(allByC1[rec.c1]={mins:0,secList:[]});
      g.mins+=m; g.secList.push({name,m});
    }
  });
  return {bucketByDate, allByC1};
}
function renderSum(){
  const byDate=document.getElementById('byDate').checked;
  const c2Mode=document.getElementById('c2Mode').value;
  const {bucketByDate,allByC1}=summarize(byDate);
  const area=document.getElementById('sumArea'); const html=[];
  function makeLines(list){
    const dup=list.map(s=>`${esc(s.name)}ï¼ˆ${fmt(s.m)} ${t('minutes')}ï¼‰`).join(' + ');
    const mp={}; list.forEach(s=>{ (mp[s.name]||(mp[s.name]=[])).push(s.m); });
    const uniqMap=Object.fromEntries(Object.entries(mp).map(([k,arr])=>[k,arr.reduce((a,b)=>a+b,0)]));
    return {dup,uniqMap};
  }
  if(byDate){
    const dates=Object.keys(bucketByDate).sort((a,b)=>{
      const aa=/^\d{4}-\d{2}-\d{2}$/.test(a)?a:'9999-99-99';
      const bb=/^\d{4}-\d{2}-\d{2}$/.test(b)?b:'9999-99-99';
      return aa.localeCompare(bb);
    });
    dates.forEach(d=>{
      const groups=bucketByDate[d]; let dayTotal=0; Object.values(groups).forEach(g=>dayTotal+=g.mins);
      const weekText=/^\d{4}-\d{2}-\d{2}$/.test(d)?fmtWeekParen(d):'';
      html.push(`<div class='dateSec'><div class='dateHead'>ğŸ“… ${esc(d)}${weekText}${d===t('dateUnk')?` <span class='mini'>${t('dateNote')}</span>`:""}</div>`);
      Object.keys(groups).sort().forEach(k=>{
        const g=groups[k]; const {dup,uniqMap}=makeLines(g.secList);
        html.push(`<div class='sum'><div><b>${esc(k)}</b></div>`);
        if(c2Mode==='dup'||c2Mode==='both'){ html.push(`<div class='row'>${t('sumDup')}${dup||"<span class=muted>â€”</span>"}</div>`); }
        if(c2Mode==='uniq'||c2Mode==='both'){
          if(c2Mode==='both'){ html.push(`<div class='row'>${t('sumUniqHdr')}</div>`); }
          const keys=Object.keys(uniqMap).sort();
          if(keys.length===0){ html.push(`<div class='row'><span class='muted'>â€”</span></div>`); }
          else{ keys.forEach(name=>{ html.push(`<div class='row'>* ${esc(name)}ï¼š${fmt(uniqMap[name])} ${t('minutes')}</div>`); }); }
        }
        html.push(`<div class='row'><b>${t('total')}</b> ${fmt(g.mins)} ${t('minutes')}</div></div>`);
      });
      html.push(`<div class='dateTotal'><b>${t('dayTotal')}</b> ${fmt(dayTotal)} ${t('minutes')}</div></div>`);
    });
  }else{
    html.push(`<div class='dateSec'><div class='dateHead'>ğŸ“š ${lang==='zh'?'ä¸åˆ†æ—¥æœŸï¼ˆå…¨éƒ¨åˆå¹¶ï¼‰':'All combined (no date split)'}</div>`);
    const groups=allByC1; let allTotal=0; Object.values(groups).forEach(g=>allTotal+=g.mins);
    Object.keys(groups).sort().forEach(k=>{
      const g=groups[k]; const {dup,uniqMap}=makeLines(g.secList);
      html.push(`<div class='sum'><div><b>${esc(k)}</b></div>`);
      if(c2Mode==='dup'||c2Mode==='both'){ html.push(`<div class='row'>${t('sumDup')}${dup||"<span class=muted>â€”</span>"}</div>`); }
      if(c2Mode==='uniq'||c2Mode==='both'){
        if(c2Mode==='both'){ html.push(`<div class='row'>${t('sumUniqHdr')}</div>`); }
        const keys=Object.keys(uniqMap).sort();
        if(keys.length===0){ html.push(`<div class='row'><span class='muted'>â€”</span></div>`); }
        else{ keys.forEach(name=>{ html.push(`<div class='row'>* ${esc(name)}ï¼š${fmt(uniqMap[name])} ${t('minutes')}</div>`); }); }
      }
      html.push(`<div class='row'><b>${t('total')}</b> ${fmt(g.mins)} ${t('minutes')}</div></div>`);
    });
    html.push(`<div class='dateTotal'><b>${lang==='zh'?'æ€»ä½“æ€»æ—¶é—´ï¼š':'Grand total:'}</b> ${fmt(allTotal)} ${t('minutes')}</div></div>`);
  }
  area.innerHTML = html.join('');
}

/* ===== ç‰ˆæœ¬å­˜å– ===== */
function readVersions(){ return getLS(VER_KEY,'[]'); }
function writeVersions(arr){ setLS(VER_KEY, arr); }
function makeSnapshot(){
  const raw=getLS(RAW_KEY,'""');
  const snap={ ts:nowTs(), raw, labelMap, c1:Array.from(c1Sug), c2:Array.from(c2Sug), cfg };
  const arr=readVersions(); arr.push(snap); while(arr.length>5) arr.shift(); writeVersions(arr);
}
function readAutoVersions(){ return getLS(VER_AUTO_KEY,'[]'); }
function writeAutoVersions(arr){ setLS(VER_AUTO_KEY, arr); }
let autoTimer=null, lastAutoSig='';
function currentStateForSig(){ const raw=getLS(RAW_KEY,'""'); return JSON.stringify({raw,labelMap,cfg}); }
function scheduleAutoSave(reason){
  const sig=currentStateForSig(); if(sig===lastAutoSig) return;
  clearTimeout(autoTimer);
  autoTimer=setTimeout(()=>{
    const raw=getLS(RAW_KEY,'""');
    const snap={ ts:nowTs(), reason:reason||'', raw, labelMap, c1:Array.from(c1Sug), c2:Array.from(c2Sug), cfg };
    const arr=readAutoVersions(); arr.push(snap); while(arr.length>2) arr.shift(); writeAutoVersions(arr);
    lastAutoSig=sig;
  },800);
}
function exportJSON(obj,fname){
  const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fname;
  document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
}

/* ===== å†å²é¢æ¿ ===== */
function showHistory(){
  const box=document.getElementById('histBody');
  const autos=readAutoVersions(); const manual=readVersions();
  const makeCard=(snap,idx,total,scope)=>{
    const rawLines=(snap.raw||'').split(/\r?\n/).length;
    const labelCnt=Object.keys(snap.labelMap||{}).length;
    const l1Cnt=new Set(Object.values(snap.labelMap||{}).map(x=>x.c1)).size;
    const l2Cnt=new Set(Object.values(snap.labelMap||{}).map(x=>x.c2)).size;
    const title=`${t('histSnap')} #${total-idx} Â· ${tsFmt(snap.ts)}${snap.reason?(' Â· '+esc(snap.reason)) : ''}`;
    return `
      <div class="histItem">
        <div class="histHead">
          <div><b>${esc(title)}</b></div>
          <div class="small">${t('histCounts')}ï¼š${rawLines}/${labelCnt}/${l1Cnt}/${l2Cnt}</div>
        </div>
        <div class="histBtns">
          <button data-act="restore" data-scope="${scope}" data-idx="${idx}">${t('btnRestore')}</button>
          <button class="secondary" data-act="export" data-scope="${scope}" data-idx="${idx}">${t('btnExport')}</button>
        </div>
      </div>`;
  };
  let html='';
  html+=`<h3>${t('histAutoTitle')}</h3>`;
  html+=autos.length?autos.map((s,i)=>makeCard(s,i,autos.length,'auto')).join(''):`<div class="muted">${lang==='zh'?'æš‚æ— è‡ªåŠ¨ä¿å­˜ã€‚å…³é”®æ“ä½œåä¼šè‡ªåŠ¨è®°å½•æœ€è¿‘ 2 ä¸ªç‰ˆæœ¬ã€‚':'No auto-saves yet. Key actions will record the last 2 automatically.'}</div>`;
  html+=`<hr class="sep"><h3>${t('histManualTitle')}</h3>`;
  html+=manual.length?manual.map((s,i)=>makeCard(s,i,manual.length,'manual')).join(''):`<div class="muted">${t('histEmpty')}</div>`;
  box.innerHTML=html;
  box.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const idx=+btn.getAttribute('data-idx'); const scope=btn.getAttribute('data-scope');
      const arr=scope==='auto'?readAutoVersions():readVersions(); const snap=arr[idx]; if(!snap) return;
      if(btn.getAttribute('data-act')==='export'){
        exportJSON(snap,`AnnotSnapshot_${scope}_${tsFmt(snap.ts).replace(/[: ]/g,'_')}.json`);
      }else{
        setLS(RAW_KEY,snap.raw||'');
        labelMap=snap.labelMap||{}; setLS(MAP_KEY,labelMap);
        c1Sug.clear(); (snap.c1||[]).forEach(v=>c1Sug.add(v));
        c2Sug.clear(); (snap.c2||[]).forEach(v=>c2Sug.add(v));
        setLS(SUG1_KEY,Array.from(c1Sug)); setLS(SUG2_KEY,Array.from(c2Sug));
        cfg=snap.cfg||defaultCfg; saveCfg();
        updDatalist('dl1',c1Sug); updDatalist('dl2',c2Sug);
        render(getLS(RAW_KEY,'""')); renderSum();
        document.getElementById('histModal').classList.add('hidden');
      }
    });
  });
  document.getElementById('histModal').classList.remove('hidden');
}

/* ===== ç»Ÿè®¡å‡½æ•° ===== */
function countEntriesInText(text){
  const lines=(text||'').replace(/\r\n?/g,'\n').split('\n');
  let cnt=0; for(const ln of lines){ if(isEntryLine(ln)) cnt++; } return cnt;
}
function countEntriesBeforeLine(lines,L){
  let cnt=0; for(let i=0;i<L;i++){ if(isEntryLine(lines[i])) cnt++; } return cnt;
}

/* ===== æ’å…¥ç²˜è´´ ===== */
function openInsert(){
  const raw=getLS(RAW_KEY,'""')||''; if(!raw){ alert(t('insNoRaw')); return; }
  document.getElementById('insTail').value=0;
  document.getElementById('insText').value='';
  updateInsertPreview();
  document.getElementById('insertModal').classList.remove('hidden');
}
function updateInsertPreview(){
  const raw=getLS(RAW_KEY,'""')||''; const lines=raw.split(/\r?\n/);
  let nTail=Math.max(0, +document.getElementById('insTail').value||0); nTail=Math.min(nTail,lines.length);
  const slice=nTail>0?lines.slice(-nTail):[];
  document.getElementById('insPreview').textContent=slice.join('\n');
  const L=lines.length-nTail;
  const addText=document.getElementById('insText').value||'';
  const addLines=addText?addText.replace(/\r\n?/g,'\n').split('\n').length:0;
  const addEntries=countEntriesInText(addText);
  const info=t('insInfoTpl').replace('{total}',lines.length).replace('{pos}',L).replace('{addLines}',addLines).replace('{addEntries}',addEntries);
  document.getElementById('insInfo').textContent=info;
}
function doInsert(){
  const addText=document.getElementById('insText').value||'';
  const raw=getLS(RAW_KEY,'""')||''; const lines=raw.split(/\r?\n/);
  let nTail=Math.max(0, +document.getElementById('insTail').value||0); nTail=Math.min(nTail,lines.length);
  const L=lines.length-nTail;

  const oldEntriesBefore=countEntriesBeforeLine(lines,L);
  const addEntries=countEntriesInText(addText);

  const left=lines.slice(0,L).join('\n'), right=lines.slice(L).join('\n');
  const sepL=left&&addText?'\n':''; const sepR=addText&&right?'\n':'';
  const newRaw=(left||'')+sepL+addText+sepR+(right||'');

  if(addEntries>0){
    const newMap={};
    Object.entries(labelMap||{}).forEach(([k,v])=>{
      const m=/^e(\d+)$/.exec(k); if(!m){ newMap[k]=v; return; }
      const idx=+m[1]; const newIdx=idx>oldEntriesBefore? idx+addEntries : idx;
      newMap['e'+newIdx]=v;
    });
    labelMap=newMap; saveMap();
  }
  setLS(RAW_KEY,newRaw); render(newRaw);
  document.getElementById('curText').textContent=''; document.getElementById('curMeta').textContent='';
  document.getElementById('tagBtn').disabled=true;
  scheduleAutoSave('insert_paste');
  document.getElementById('insertModal').classList.add('hidden');
}

/* ===== åˆ é™¤æœ«è¡Œ ===== */
function openDeleteModal(){
  const raw=getLS(RAW_KEY,'""')||''; const lines=raw.split(/\r?\n/);
  if(!raw||lines.length===0){ alert(t('delNone')); return; }
  document.getElementById('delInfo').textContent=t('delInfo').replace('{n}',lines.length);
  const inp=document.getElementById('delCount'); if(!inp.value || +inp.value<1) inp.value=1;
  updateDelPreview();
  document.getElementById('delModal').classList.remove('hidden');
}
function updateDelPreview(){
  const raw=getLS(RAW_KEY,'""')||''; const lines=raw.split(/\r?\n/);
  let n=Math.max(1, +document.getElementById('delCount').value||1); n=Math.min(n,lines.length);
  document.getElementById('delPreview').textContent=lines.slice(-n).join('\n');
}
function doDeleteTail(){
  const raw=getLS(RAW_KEY,'""')||''; let lines=raw.split(/\r?\n/);
  if(lines.length===0){ document.getElementById('delModal').classList.add('hidden'); return; }
  let n=Math.max(1, +document.getElementById('delCount').value||1); n=Math.min(n,lines.length);
  if(!confirm(t('delConfirm').replace('{n}',n))) return;
  lines=lines.slice(0,lines.length-n);
  const newRaw=lines.join('\n'); setLS(RAW_KEY,newRaw); render(newRaw);
  pruneLabelMapToCurrentEntries();
  document.getElementById('curText').textContent=''; document.getElementById('curMeta').textContent='';
  document.getElementById('tagBtn').disabled=true;
  scheduleAutoSave('delete_last_'+n);
  document.getElementById('delModal').classList.add('hidden');
}
function pruneLabelMapToCurrentEntries(){
  const live=new Set(Array.from(document.querySelectorAll('.entry')).map(el=>el.dataset.id));
  let removed=0; Object.keys(labelMap).forEach(k=>{ if(!live.has(k)){ delete labelMap[k]; removed++; } });
  if(removed){ saveMap(); scheduleAutoSave('prune_labels_'+removed); }
}

/* ===== å¯¼å…¥ / å¯¼å‡º ===== */
function doExport(){
  const obj={ ts:nowTs(), raw:getLS(RAW_KEY,'""')||'', labelMap, c1:Array.from(c1Sug), c2:Array.from(c2Sug), cfg };
  exportJSON(obj, `DanmuTag_${tsFmt(obj.ts).replace(/[: ]/g,'_')}.json`);
}
function doImportFile(){
  const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
  inp.onchange=()=>{
    const f=inp.files&&inp.files[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const obj=JSON.parse(reader.result);
        const raw=obj.raw||'';
        setLS(RAW_KEY,raw);
        labelMap=obj.labelMap||{}; saveMap();
        c1Sug.clear(); (obj.c1||[]).forEach(v=>c1Sug.add(v));
        c2Sug.clear(); (obj.c2||[]).forEach(v=>c2Sug.add(v));
        setLS(SUG1_KEY,Array.from(c1Sug)); setLS(SUG2_KEY,Array.from(c2Sug));
        cfg=obj.cfg?Object.assign({},defaultCfg,obj.cfg):cfg; saveCfg();
        updDatalist('dl1',c1Sug); updDatalist('dl2',c2Sug);
        render(raw); renderSum();
        scheduleAutoSave('import');
      }catch(e){ alert('Invalid JSON'); }
    };
    reader.readAsText(f);
  };
  inp.click();
}

/* ===== å…³é”®è¯ / å¸®åŠ© ===== */
function openKw(){
  const m=document.getElementById('kwModal');
  document.getElementById('kw_blue_tags').value=(cfg.blue.tags||[]).join('\n');
  document.getElementById('kw_blue_expr').value=cfg.blue.minuteExpr||defaultCfg.blue.minuteExpr;
  document.getElementById('kw_blue_suffix').value=cfg.blue.suffix||'åˆ†é’Ÿ';
  document.getElementById('kw_green_words').value=(cfg.green.keywords||[]).join('\n');
  document.getElementById('kw_green_only_when_no_blue').checked=!!cfg.green.onlyWhenNoBlue;
  m.classList.remove('hidden');
}
function saveKw(){
  const tags=document.getElementById('kw_blue_tags').value.split('\n').map(s=>s.trim()).filter(Boolean);
  const expr=document.getElementById('kw_blue_expr').value.trim()||defaultCfg.blue.minuteExpr;
  const suffix=document.getElementById('kw_blue_suffix').value.trim()||(lang==='zh'?'åˆ†é’Ÿ':'minutes');
  const greens=document.getElementById('kw_green_words').value.split('\n').map(s=>s.trim()).filter(Boolean);
  const onlyNoBlue=document.getElementById('kw_green_only_when_no_blue').checked;
  try{ new RegExp(`(${expr})\\s*${escReg(suffix)}`,'i'); }catch(e){ alert((lang==='zh'?'åˆ†é’Ÿè¡¨è¾¾å¼ä¸æ˜¯æœ‰æ•ˆçš„æ­£åˆ™ï¼š':'Invalid regex: ')+e.message); return; }
  cfg={ blue:{tags,minuteExpr:expr,suffix}, green:{keywords:greens,onlyWhenNoBlue} };
  saveCfg(); const raw=getLS(RAW_KEY,'""'); if(raw&&raw!=="") render(raw);
  document.getElementById('kwModal').classList.add('hidden');
}
function openHelp(){
  const ex=['13:02, Oct 21, 2025ï¼›ã€å­¦ä¹ æ—¶é—´ã€‘èŠ±äº†10åˆ†é’Ÿè¯»æ–°æ–‡çŒ®','13:15, Oct 21, 2025ï¼›ã€å·¥ä½œæ—¶é—´ã€‘èŠ±äº†5+5åˆ†é’ŸåšPPT','14:00ï¼›å’Œæœ¬ç§‘ç”Ÿè®¨è®ºå®éªŒåˆºæ¿€é—®é¢˜ï¼ˆæœªè®¡æ—¶ï¼‰','15:30, Oct 21, 2025ï¼›ã€å­¦ä¹ æ—¶é—´ã€‘ç­‰æ•ˆèŠ±äº†3åˆ†é’Ÿå›é¡¾å…¬å¼'].join('\n');
  const stepsZh=`1ï¼‰ç‚¹"ç²˜è´´/è¿½åŠ /æ’å…¥"â†’ ç²˜è´´åŸæ–‡ â†’ "è§£æ/æ’å…¥"ã€‚  
2ï¼‰å·¦æ ç‚¹å‡»è“/ç–‘ä¼¼è¡Œï¼Œåœ¨å³ä¾§å¡«å†™"ä¸€çº§/äºŒçº§"å¹¶"æ‰“æ ‡ç­¾"ã€‚  
3ï¼‰ç‚¹"æ±‡æ€»"ï¼Œé»˜è®¤æŒ‰æ—¥æœŸå»é‡é€è¡Œï¼Œåº•éƒ¨æ˜¾ç¤º"å½“æ—¥æ€»æ—¶é—´"ï¼Œæ—¥æœŸæ—æ ‡æ³¨æ˜ŸæœŸã€‚  
4ï¼‰"ä¿å­˜æ ‡ç­¾"å»ºç«‹æ‰‹åŠ¨å¿«ç…§ï¼›å…³é”®æ“ä½œè‡ªåŠ¨ä¿å­˜æœ€è¿‘ 2 ä¸ªç‰ˆæœ¬ï¼›"å†å²"å¯æ¢å¤/å¯¼å‡ºã€‚  
5ï¼‰"å®šä¹‰å…³é”®è¯"å¯å¾®è°ƒè“/ç»¿å‘½ä¸­è§„åˆ™ä¸åˆ†é’Ÿåç¼€ï¼›"å¯¼å…¥JSON/å¯¼å‡ºJSON"å¯å¤‡ä»½/è¿ç§»ã€‚`.trim();
  const stepsEn=`1) "Paste/Append/Insert" â†’ paste text â†’ "Parse/Insert".  
2) Click blue/suspect rows, fill L1/L2 on the right and "Tag".  
3) "Summarize": split-by-date, unique-only, day total, weekday next to date.  
4) "Save Tags" takes snapshots; key actions auto-save last 2; "History" restores/exports.  
5) Tune rules in "Define Keywords"; use "Import JSON/Export" to backup/migrate.`.trim();
  const html=`<p><b>${lang==='zh'?'ä½¿ç”¨æ­¥éª¤ï¼š':'Steps:'}</b></p><p>${(lang==='zh'?stepsZh:stepsEn).replace(/\n/g,'<br>')}</p><hr class="sep"><p><b>${lang==='zh'?'ç¤ºä¾‹æ—¥å¿—ï¼š':'Sample log:'}</b></p><pre style="background:#f7f7f7;border:1px solid #eee;padding:8px;border-radius:8px;white-space:pre-wrap">${esc(ex)}</pre>`;
  document.getElementById('helpBody').innerHTML=html;
  document.getElementById('helpModal').classList.remove('hidden');
}
function loadSample(){
  const sample=['13:02, Oct 21, 2025ï¼›ã€å­¦ä¹ æ—¶é—´ã€‘èŠ±äº†10åˆ†é’Ÿè¯»æ–°æ–‡çŒ®','13:15, Oct 21, 2025ï¼›ã€å·¥ä½œæ—¶é—´ã€‘èŠ±äº†5+5åˆ†é’ŸåšPPT','14:00ï¼›å’Œæœ¬ç§‘ç”Ÿè®¨è®ºå®éªŒåˆºæ¿€é—®é¢˜ï¼ˆæœªè®¡æ—¶ï¼‰','15:30, Oct 21, 2025ï¼›ã€å­¦ä¹ æ—¶é—´ã€‘ç­‰æ•ˆèŠ±äº†3åˆ†é’Ÿå›é¡¾å…¬å¼','16:10ï¼›æ™®é€šè®°å½•ä¸€è¡Œï¼ˆæ— è®¡æ—¶ï¼‰'].join('\n');
  setLS(RAW_KEY,sample); render(sample); scheduleAutoSave('load_sample'); document.getElementById('helpModal').classList.add('hidden');
}

/* ===== ä¿®æ”¹æŒ‡å®šè¡Œ ===== */
function openEditModal(){
  const raw=getLS(RAW_KEY,'""')||''; if(!raw){ alert(t('insNoRaw')); return; }
  const lines=raw.split(/\r?\n/);
  const inp=document.getElementById('editLine');
  inp.min=1; inp.max=Math.max(1,lines.length); inp.value=String(lines.length); // é»˜è®¤é€‰ä¸­æœ€åä¸€è¡Œ
  document.getElementById('editArea').value=lines[lines.length-1]||'';
  updateEditPreview();
  document.getElementById('editModal').classList.remove('hidden');
}
function updateEditPreview(){
  const raw=getLS(RAW_KEY,'""')||''; const lines=raw.split(/\r?\n/);
  let L=Math.max(1, Math.min(lines.length, +document.getElementById('editLine').value||1));
  const head=`${t('editLineNum')} ${L} / ${lines.length}`;
  document.getElementById('editInfo').textContent=head;
  const tail=lines.slice(L-1); if(tail.length){ tail[0]='â–¶ '+tail[0]; }
  document.getElementById('editPreview').textContent=tail.join('\n');
  document.getElementById('editArea').value=lines[L-1]||'';
}
function applyEdit(){
  const raw=getLS(RAW_KEY,'""')||''; const lines=raw.split(/\r?\n/);
  let L=Math.max(1, Math.min(lines.length, +document.getElementById('editLine').value||1));
  const oldLine=lines[L-1]||'';
  const newText=(document.getElementById('editArea').value||'').replace(/\r\n?/g,'\n');

  // è®¡ç®— entry å˜åŒ–
  const entriesBefore=countEntriesBeforeLine(lines, L-1);
  const oldEntries=countEntriesInText(oldLine); // 0 æˆ– 1
  const newEntries=countEntriesInText(newText); // å¯ä¸º 0/1/å¤š

  // ç»„è£…æ–° raw
  const left=lines.slice(0,L-1).join('\n');
  const right=lines.slice(L).join('\n');
  const newRaw = (left?left+'\n':'') + newText + (right?('\n'+right):'');

  // æ›´æ–°æ ‡ç­¾æ˜ å°„
  const threshold = entriesBefore + oldEntries; // è¯¥è¡Œä¹‹åçš„é¦–ä¸ªâ€œåç»­â€æ¡ç›®ç´¢å¼•é˜ˆå€¼
  const delta = newEntries - oldEntries;
  const newMap={};

  // 1) ä¿ç•™/åˆ é™¤ï¼šè¯¥è¡Œè‡ªèº«çš„æ ‡ç­¾ï¼ˆä»…å½“åŸæœ¬æ˜¯ 1 ä¸ªæ¡ç›®ï¼‰
  if(oldEntries===1){
    const idOld='e'+(entriesBefore+1);
    const rec=labelMap[idOld];
    if(rec){
      if(newEntries>=1){
        // ä»ç„¶åœ¨è¯¥ä½ç½®ä¿ç•™ä¸€ä¸ªæ¡ç›®ï¼šæ ‡ç­¾ç•™åœ¨ e(entriesBefore+1)
        newMap['e'+(entriesBefore+1)] = rec;
      } // newEntries==0 åˆ™ä¸¢å¼ƒè¯¥æ ‡ç­¾ï¼ˆè¯¥è¡Œå·²ä¸å†æ˜¯æ¡ç›®ï¼‰
    }
  }

  // 2) å¹³ç§»â€œé˜ˆå€¼ä¹‹åâ€çš„æ‰€æœ‰æ ‡ç­¾
  Object.entries(labelMap).forEach(([k,v])=>{
    const m=/^e(\d+)$/.exec(k);
    if(!m){ newMap[k]=v; return; }
    const idx=+m[1];

    // è·³è¿‡å·²åœ¨æ­¥éª¤1å¤„ç†ä¸­æ¶‰åŠçš„â€œè¯¥è¡Œè‡ªèº«çš„æ—§æ ‡ç­¾â€
    if(oldEntries===1 && idx === (entriesBefore+1)) return;

    if(idx > threshold){
      const to = idx + delta;
      newMap['e'+to] = v;
    }else{
      newMap['e'+idx] = v;
    }
  });

  labelMap=newMap; saveMap();
  setLS(RAW_KEY,newRaw);
  render(newRaw); renderSum();
  scheduleAutoSave('edit_line');
  document.getElementById('editModal').classList.add('hidden');
}

/* ===== äº‹ä»¶ç»‘å®š ===== */
function updDatalist(id,set){ const dl=document.getElementById(id); dl.innerHTML=''; Array.from(set).sort().forEach(v=>{ const o=document.createElement('option'); o.value=v; dl.appendChild(o); }); }

let appendMode=false;
document.addEventListener('DOMContentLoaded',()=>{
  applyI18n(); lastAutoSig=currentStateForSig();
  updDatalist('dl1',c1Sug); updDatalist('dl2',c2Sug);

  // ç²˜è´´ / è¿½åŠ 
  document.getElementById('pasteBtn').addEventListener('click', ()=>{ appendMode=false; document.getElementById('pasteTitle').textContent=t('pasteTitle'); document.getElementById('pasteInput').value=''; document.getElementById('pasteModal').classList.remove('hidden'); });
  document.getElementById('appendBtn').addEventListener('click', ()=>{ appendMode=true; document.getElementById('pasteTitle').textContent=t('pasteTitleAppend'); document.getElementById('pasteInput').value=''; document.getElementById('pasteModal').classList.remove('hidden'); });
  document.getElementById('cancelPaste').addEventListener('click',()=>document.getElementById('pasteModal').classList.add('hidden'));
  document.getElementById('parseBtn').addEventListener('click',()=>{
    const newText=document.getElementById('pasteInput').value||'';
    if(!newText){ document.getElementById('pasteModal').classList.add('hidden'); return; }
    if(appendMode){
      const old=getLS(RAW_KEY,'""')||'';
      const merged=old?(old.replace(/\s+$/,'')+'\n'+newText):newText;
      setLS(RAW_KEY,merged); render(merged); scheduleAutoSave('append');
    }else{
      if(Object.keys(labelMap).length>0){
        if(!confirm(t('confirmReparse'))){ return; }
        labelMap={}; setLS(MAP_KEY,labelMap); document.getElementById('sumArea').innerHTML='';
        scheduleAutoSave('reparse_clear_labels');
      }
      setLS(RAW_KEY,newText); render(newText); scheduleAutoSave('parse_replace');
    }
    document.getElementById('pasteModal').classList.add('hidden');
  });

  // æ’å…¥ç²˜è´´
  document.getElementById('insertBtn').addEventListener('click', openInsert);
  document.getElementById('insCancel').addEventListener('click',()=>document.getElementById('insertModal').classList.add('hidden'));
  document.getElementById('insTail').addEventListener('input', updateInsertPreview);
  document.getElementById('insText').addEventListener('input', updateInsertPreview);
  document.getElementById('insDo').addEventListener('click', doInsert);

  // é‡æ–°è§£æ
  document.getElementById('reparseBtn').addEventListener('click',()=>{
    const raw=getLS(RAW_KEY,'""');
    if(!raw||raw===""){ document.getElementById('pasteInput').value=''; appendMode=false; document.getElementById('pasteTitle').textContent=t('pasteTitle'); document.getElementById('pasteModal').classList.remove('hidden'); return; }
    if(Object.keys(labelMap).length>0){
      if(!confirm(t('confirmReparse'))) return;
      labelMap={}; setLS(MAP_KEY,labelMap); document.getElementById('sumArea').innerHTML='';
      scheduleAutoSave('reparse_clear_labels');
    }
    render(raw); scheduleAutoSave('reparse_render');
  });

  // åˆ é™¤æœ«è¡Œ
  document.getElementById('delBtn').addEventListener('click', openDeleteModal);
  document.getElementById('delCancel').addEventListener('click', ()=>document.getElementById('delModal').classList.add('hidden'));
  document.getElementById('delCount').addEventListener('input', updateDelPreview);
  document.getElementById('delDo').addEventListener('click', doDeleteTail);

  // å…³é”®è¯
  document.getElementById('kwBtn').addEventListener('click', openKw);
  document.getElementById('kwCancel').addEventListener('click',()=>document.getElementById('kwModal').classList.add('hidden'));
  document.getElementById('kwReset').addEventListener('click',()=>{
    if(!confirm(lang==='zh'?'æ¢å¤åˆ°é»˜è®¤å…³é”®è¯ä¸åˆ†é’Ÿè¡¨è¾¾å¼ï¼Ÿ':'Reset to default keywords and pattern?')) return;
    cfg=JSON.parse(JSON.stringify(defaultCfg)); saveCfg(); openKw();
  });
  document.getElementById('kwSave').addEventListener('click', saveKw);

  // å¸®åŠ©/è¯­è¨€
  document.getElementById('helpBtn').addEventListener('click', openHelp);
  document.getElementById('closeHelp').addEventListener('click', ()=>document.getElementById('helpModal').classList.add('hidden'));
  document.getElementById('loadSample').addEventListener('click', loadSample);
  document.getElementById('langBtn').addEventListener('click', ()=>{ lang=(lang==='zh'?'en':'zh'); localStorage.setItem(LANG_KEY,lang); applyI18n(); render(getLS(RAW_KEY,'""')); renderSum(); });

  // æ‰“æ ‡ç­¾
  document.getElementById('tagBtn').addEventListener('click',()=>{
    const current=document.querySelector('.entry.selected'); if(!current) return;
    const id=current.dataset.id;
    const c1=document.getElementById('c1').value.trim();
    const c2=document.getElementById('c2').value.trim();
    const over=document.getElementById('overMin').value.trim();
    if(!c1||!c2){ alert(t('alertNeedTitles')); return; }
    if(over && isNaN(parseFloat(over))){ alert(t('alertOverNum')); return; }
    c1Sug.add(c1); c2Sug.add(c2); updDatalist('dl1',c1Sug); updDatalist('dl2',c2Sug);
    setLS(SUG1_KEY,Array.from(c1Sug)); setLS(SUG2_KEY,Array.from(c2Sug));
    labelMap[id]={ c1, c2, overMin:over?parseFloat(over):null }; saveMap();
    let tag=current.querySelector('.badge'); if(!tag){ tag=document.createElement('span'); tag.className='badge'; current.appendChild(tag); }
    tag.textContent=c1+' / '+c2+(over?(' Â· '+over+'m'):'');
    scheduleAutoSave('tag');
  });

  // æ±‡æ€»
  document.getElementById('sumBtn').addEventListener('click', renderSum);
  document.getElementById('byDate').addEventListener('change', renderSum);
  document.getElementById('c2Mode').addEventListener('change', renderSum);

  // æ¸…ç©ºæ ‡ç­¾
  document.getElementById('clearBtn').addEventListener('click',()=>{
    if(confirm(t('confirmClear'))){
      labelMap={}; setLS(MAP_KEY,labelMap); document.getElementById('sumArea').innerHTML='';
      document.querySelectorAll('.entry .badge').forEach(x=>x.remove());
      scheduleAutoSave('clear_labels');
    }
  });

  // æ‰‹åŠ¨ä¿å­˜ & å†å²
  document.getElementById('saveSnapBtn').addEventListener('click', ()=>{ makeSnapshot(); alert(t('toastSaved')); });
  document.getElementById('histBtn').addEventListener('click', showHistory);
  document.getElementById('closeHist').addEventListener('click', ()=>document.getElementById('histModal').classList.add('hidden'));

  // å¯¼å…¥ / å¯¼å‡º
  document.getElementById('exportBtn').addEventListener('click', doExport);
  document.getElementById('importBtn').addEventListener('click', doImportFile);

  // ä¿®æ”¹æŒ‡å®šè¡Œ
  document.getElementById('editBtn').addEventListener('click', openEditModal);
  document.getElementById('editCancel').addEventListener('click', ()=>document.getElementById('editModal').classList.add('hidden'));
  document.getElementById('editLine').addEventListener('input', updateEditPreview);
  document.getElementById('editApply').addEventListener('click', applyEdit);

  // åˆå§‹æ¸²æŸ“
  const raw=getLS(RAW_KEY,'""'); if(raw&&raw!=="") render(raw);
});
</script>
